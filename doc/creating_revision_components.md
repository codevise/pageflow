# Creating Revision Components

Revisions are deep copies of an entry's data. Revision components are
models that shall be copied as part of a revision. Plugins can
register additional revision components.

## Register a Revision Component

Create a custom model and include the `Pageflow::RevisionComponent`
concern.

```ruby
# rainbow/app/models/rainbow/chapter.rb
module Rainbow
  class Chapter < ActiveRecord::Base
    include Pageflow::RevisionComponent
  end
end
```

In the corresponding migration, we need to define attributes to
associate the model with a revision and store a perma id. Perma ids
are assigned automatically upon record creation and allow for stable
references across revisions.

```ruby
# db/migrate/xxxxx_create_rainbow_chapters.rb
class CreateRainbowChapters < ActiveRecord::Migration[5.2]
  def change
    create_table :rainbow_chapters do |t|
      t.belongs_to(:revision, index: true)
      t.integer(:perma_id)

      # Further custom columns...

      t.timestamps
    end
  end
end
```

To ensure records are copied along with the revision, we need to
register the revision component:

```ruby
# rainbow/lib/rainbow/plugin.rb
module Rainbow
  class Plugin < Pageflow::Plugin
    def configure(config)
      config.revision_components.register(Chapter)
    end
  end
end
```

Revision components can also be
[scoped to certain entry types](./creating_entry_types.md#scoping-by-entry-type):

```ruby
# rainbow/lib/rainbow/plugin.rb
module Rainbow
  class Plugin < Pageflow::Plugin
    def configure(config)
      config.for_entry_type(Rainbow.entry_type) do |c|
        c.revision_components.register(Chapter)
      end
    end
  end
end
```

Entry types also allow defining
[custom editor controller](./creating_entry_types.md#rest-controllers)
that can be used to manage revision components of a certain type.

## Composite Revision Components

A revision component can itself be associated with other models that
need to be copied as well. Chapters, for example, may have many
pages:

```ruby
# rainbow/app/models/rainbow/chapter.rb
module Rainbow
  class Chapter < ActiveRecord::Base
    include Pageflow::RevisionComponent

    has_many :pages
    nested_revision_components :pages
  end
end

# rainbow/app/models/rainbow/page.rb
module Rainbow
  class Page < ActiveRecord::Base
    include Pageflow::NestedRevisionComponent
  end
end
```

Pages will now be copied along with their chapter when a revision is
created. They will also be included during entry export and import.

Nested revision components can themselves declare nested revision
components.

Nested revision components do not have a `perma_id` attribute by
default. Include `Pageflow::AutoGeneratedPermaId` and add a `perma_id`
attribute, to also assign stable perma ids to nested revision
components.

```ruby
# rainbow/app/models/rainbow/page.rb
module Rainbow
  class Page < ActiveRecord::Base
    include Pageflow::NestedRevisionComponent
    include Pageflow::AutoGeneratedPermaId
  end
end
```
